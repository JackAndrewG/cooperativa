<script src="//cdnjs.cloudflare.com/ajax/libs/minicart/3.0.5/minicart.min.js"></script>
<script src="https://test.oppwa.com/v1/paymentWidgets.js?checkoutId=E541A0846631E1BCCEBFCCA07F7E4FC2.uat01-vm-tx01"></script>
<div class="gallery">
    <div class="jumbotron">
        <h1 class="card-title">Comprar Boletos</h1>
    </div>

    <!-- HE-->

    {{#if info }}
    <div class="alert alert-success">
        {{ info }}
    </div>
    {{/if}}
    <div class="card-columns" style="display:flex;">
        <div class="card" style="width: 30rem;">
            <img src="images/boleto.png" class="card-img-top" alt="...">
            <div class="card-body">
                <h2 class="text-center"><b>Busca tu pasaje de bus en TransNIC!  </b></h2>
                <form action="/compra_buscar" method="POST">
                    <br>
                    <div class="row text-left" style="margin-bottom:4px;">
                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 block-display">
                            <div class="input-group" >
                                <div class="input-group-addon">Origen</div>
                                <select name="origen_buscar" id="origen_buscar">
                                    <option value="">Seleccione...</option>
                                    {{#each frecuencias as |frecuencia i| }}
                                    <option id="opOrigen{{i}}" value="{{ frecuencia.rutum.origen }}">{{ frecuencia.rutum.origen }}</option>
                                    <script>
                                        var html = "";
                                        if ($('#opOrigen{{i}}').val("{{ frecuencia.rutum.origen }}") != "HOLA") {

                                            html = html + '<option id="opOrigen{{i}}" value="{{ frecuencia.rutum.origen }}">{{ frecuencia.rutum.origen }}</option>';

                                        }
                                        $('#origen_buscar').html(html);
                                    </script>
                                    {{/each}}
                                </select>
                                <span class="error-msg"></span>
                            </div>
                            <div class="input-group" >
                                <div class="input-group-addon">Destino</div>
                                <select name="destino_buscar" id="destino_buscar">
                                    <option value="">Seleccione...</option>
                                    {{#each frecuencias as |frecuencia i| }}
                                    <option value="{{ frecuencia.rutum.destino }}">{{ frecuencia.rutum.destino }}</option>
                                    {{/each}}
                                </select>
                                <span class="error-msg"></span>
                            </div>
                        </div>



                        <div class="col-lg-12 col-md-12 ">
                            <div class="input-group" >
                                <button type="submit" class="btn btn-primary mb-2">Busca tu pasaje</button>
                            </div>
                        </div>
                    </div>
                </form>

            </div>
        </div>
<!--  este form de aqui sirve para realizar el pago con tarjeta, es un servicio web lo pueden consultar desde el script que se encuentra al princiopio de esta vista-->
        <div class="modal fade" id="ModalPago" tabindex="-1" role="dialog" aria-labelledby="ModalPagoTitle" aria-hidden="true" tyle="overflow-y: scroll;">
          <form style="background-color:#f6f6f5;" action="http://localhost:3000/pagar" class="paymentWidgets" data-brands="VISA MASTER AMEX"></form>
        </div>
                <!-- Modal Comprar -->
                <form id="formBus"  action="/comprar" method="post" >
                    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalCenterTitle">{{titulo}}</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">

                                    <input type="hidden" name="external" value="0" id="external">
                                    <input type="hidden" name="id_frecuencia" id="id_frecuencia" value="4">
                                    <input type="hidden" name="asientos" id="asientos">
                                    <h3 class="bg-light" id="tituloFormulario">COMPRA DE BOLETOS</h3>
                                    <div class="form-group">
                                        <small> Nombre de Cliente :</small>
                                        <input class="form-control" type="text" name="nombre" id="nombre" placeholder="Nombres Apellidos" required value="{{usuario}}"><br>
                                    </div>
                                    <div class="form-group">
                                        <label for="origen">Ruta</label><br>
                                        <small> Origen: </small>
                                        <input class="form-control" type="text" name="origen" id="origen" placeholder="Ciudad de Partida" required minlength="3" maxlength="50" readonly><br>
                                        <small> Destino: </small>
                                        <input class="form-control" type="text" name="destino" id="destino" placeholder="Ciudad de Llegada" required minlength="3" maxlength="50" readonly><br>
                                    </div>
                                    <div class="form-group">
                                      <label for="fecha">Fecha y Hora</label><br>
                                        <small> Fecha: </small>
                                        <input class="form-control" type="date" name="fecha" id="fecha" required readonly>
                                        <small> Hora: </small>
                                        <input class="form-control" type="time" name="hora" id="hora" required readonly>
                                    </div>
                                    <div class="form-group">
                                        <small> Unidad de transporte: </small>
                                        <input class="form-control" type="number" name="numeroBus" id="numeroBus" placeholder="00" required min="1" max="999" readonly>
                                    </div>
                                    <div class="form-group">
                                        <small> Cantidad de Asientos: </small>
                                        <input class="form-control" type="number" name="cantidad_asientos" id="cantidad_asientos" placeholder="00" required min="1" max="40">
                                    </div>
                                    <div class="form-group">
                                      <div class="textbox-wrap">
                                      <label for="total"> <b>Total: </b> </label>
                                      <i class="fa fa-dollar"> </i>
                                      <input class="number" type="text" name="total" id="total" readonly>
                                      </div>
                                    </div>
                                    <!-- lo siguiente crea 40 asientos separados por columnas de 10 filas -->
                                    <script>
                                    function crearAsientos() {
                                        var html = "";
                                        var n=1; //n es el valor de cada asiento
                                          for (var h = 0; h < 4; h++) {
                                            html += '<ul style="float:left;">';
                                            for (var i = 0; i < 10; i++) {
                                              if (h>0) {
                                                n=2;
                                                if (h>1) {
                                                  n=3;
                                                  if (h>2) {
                                                    n=4;
                                                  }
                                                }
                                              }
                                              if (i>0) {
                                                n=i*4+n;
                                              }
                                              html += '<li>';
                                                html += '<a class="btn btn-secondary fa fa-stop" id="bt'+n+'" onclick="seleccion('+n+')">';
                                                  html += '<b>'+n+'</b>';
                                                html += '</a>';
                                              html += '</li>';
                                              n=1;
                                            }
                                            html += '</ul>';
                                          }
                                        $("#espacioAsientos div").html(html);
                                    }
                                      var arregloAsientos=[];
                                      //funcion que permite ir almacenando en el arregloAsientos cada asiento seleccionado
                                    function seleccion(numeroAsiento){
                                          arregloAsientos.push(numeroAsiento);
                                          $('#bt'+numeroAsiento).attr('hidden', 'true');
                                          $("#cantidad_asientos").val(arregloAsientos.length);
                                          var aux='';
                                          //esta parte sirve para almacenar cada elemento del arreglo en un input hidden para su guardado
                                          for (var i = 0; i < arregloAsientos.length; i++) {
                                            aux=aux+arregloAsientos[i]+',';
                                            $("#asientos").val(aux);
                                          }
                                      console.log(arregloAsientos);
                                    };
                                    $(document).ready(function () {

                                      var asientosOcupados=[];
                                      //para cada string de numeroAsiento lo almacena en un arreglo asientosOcupados
                                      {{#each boletos as |boleto i|}}
                                      asientosOcupados=asientosOcupados+"{{boleto.NumeroAsiento}}".split(",");
                                      {{/each}}
                                      //almacena tambien las comas por eso hay que hacer otro split para obtener un arreglo limpio *SE PUEDE MEJORAR ESTO
                                      console.log(asientosOcupados.split(','));
                                        crearAsientos();
                                        //para cada elemento del arreglo va poniendo la propiedad hidden a los asientos
                                        for (var i = 0; i < asientosOcupados.split(',').length; i++) {
                                          $('#bt'+(asientosOcupados.split(',')[i])).attr('hidden', 'true');
                                        }
                                    });
                                    </script>
                                    <div id="espacioAsientos">
                                        <small> Seleccione los asientos deseados </small>
                                        <div></div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancelar">Cancelar</button>
                                    <button type="submit" class="btn btn-success" id="btn">Pagar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

        <div class="card" style="width: 50rem;">
            <div class="card-header"> <b>    Viajes Disponibles!</b> </div>
            <div class="card-body">

                <table class="table">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Origen</th>
                            <th scope="col">Destino</th>
                            <th scope="col">Fecha</th>
                            <th scope="col">Hora</th>
                            <th scope="col">Precio</th>
                            <th scope="col">Nro Bus</th>
                            <!--     <th scope="col">Tipo</th> -->
                            <th scope="col">Comprar</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each frecuencias as |frecuencia i| }}
                        <tr>
                            <td>{{i}}</td>
                            <td>{{ frecuencia.rutum.origen }}</td>
                            <td>{{ frecuencia.rutum.destino }}</td>
                            <td>{{ frecuencia.fecha }}</td>
                            <td>{{ frecuencia.horario }}</td>
                            <td>${{ frecuencia.rutum.valor }}</td>
                            <td>{{ frecuencia.bus.numeroBus }}</td>
                            <td>
                              <a href="/boleto/{{frecuencia.id}}" id="bComprobar{{i}}" type="button" class="btn btn-warning">Comprobar Disponibilidad</a>
                              <a href="#" id="bComprar{{i}}" class="btn btn-success" data-toggle="modal" data-target="#exampleModalCenter">Comprar</a>
                              </td>
                        <script>

                        $("#bComprar{{i}}").click(function () {
                            $("#external").val('{{frecuencia.external_id}}');
                            $("#id_frecuencia").val('{{frecuencia.id}}');
                            $("#origen").val('{{ frecuencia.rutum.origen }}');
                            $("#destino").val('{{ frecuencia.rutum.destino }}');
                            $("#fecha").val('{{ frecuencia.fecha }}');
                            $("#hora").val('{{ frecuencia.horario }}');
                            $("#numeroBus").val('{{ frecuencia.bus.numeroBus }}');
                            $("#total").val('{{ frecuencia.rutum.valor }}');
                            var cantidad = 0;
                            var suma = 0;
                            var tot = {{ frecuencia.rutum.valor }} * 1;
                            $("#cantidad_asientos").change(function () { //hay que mejorar la manera de calcular el total, ya que no se actualiza el total automaticamente al ir seleccionando asientos
                                calculos();
                            });
                            function calculos() {
                                cantidad = $('#cantidad_asientos').val();
                                suma = tot * cantidad;
                                $('#total').val(suma.toFixed(2));
                            }
                        });
                    </script>
                    </tr>
                    {{/each}}
                    </tbody>
                </table>
                {{#if boletos}}
                <p>Si hay boletos disponibles!</p>
                {{else}}
                <p>No hay boletos disponibles ;(</p>
                {{/if}}
            </div>
        </div>
    </div>
